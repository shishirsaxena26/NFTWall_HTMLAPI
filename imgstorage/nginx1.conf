worker_processes auto;

events {
    worker_connections 4096;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout 65;

    open_file_cache max=5000 inactive=120s;
    open_file_cache_valid 120s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;

    server {
        listen 80 http2;
        server_name 52.220.77.185;

        # 1) Fix trailing slash: /folder/file/ -> /folder/file
        location ~ ^/([^/]+)/([^/]+)/$ {
            return 301 /$1/$2;
        }

        # 2) Serve files (images, etc.)
        location ~ ^/([^/]+)/([^/]+)$ {
            root C:/nginx/sites;
            try_files /$1/$2 =404;
            expires 7d;
            add_header Cache-Control "public, max-age=604800";
        }

        # 3) Serve default index files for folders
        location ~ ^/([^/]+)/?$ {
            root C:/nginx/sites;
            index default.jpeg default.png index.html;
            try_files /$1/default.jpeg /$1/default.png /$1/index.html =404;
            expires 7d;
            add_header Cache-Control "public, max-age=604800";
        }

        # 4) Health check
        location = /test {
            return 200 'NGINX is working!';
            add_header Content-Type text/plain;
        }

        access_log logs/access.log;
        error_log logs/error.log debug;
    }
}
